# Устранение неполадок при миграции на Wiki.js

В процессе миграции проекта "Приключения Цветочка, Торона и Руперта" на Wiki.js могут возникнуть различные проблемы. Этот документ поможет диагностировать и решить наиболее распространенные из них.

## Проблемы с Docker

### Команда docker-compose не найдена

**Проблема**: При попытке запустить `npm run start` появляется ошибка "docker-compose: command not found".

**Решение**:

1. Установите Docker Desktop, который включает в себя Docker Compose:

   - Для macOS: https://docs.docker.com/docker-for-mac/install/
   - Для Windows: https://docs.docker.com/docker-for-windows/install/
   - Для Linux: https://docs.docker.com/engine/install/

2. После установки Docker Desktop убедитесь, что он запущен.

3. Проверьте установку командой:
   ```bash
   docker --version
   docker-compose --version
   ```

### Контейнеры не запускаются или останавливаются

**Проблема**: Контейнеры Docker не запускаются или быстро останавливаются.

**Решение**:

1. Проверьте логи:

   ```bash
   npm run logs
   ```

2. Если видите ошибки, связанные с доступом к портам, убедитесь, что порт 8080 не занят другим приложением.

3. Возможно, потребуется перезапустить Docker:
   ```bash
   npm run stop
   docker system prune -a
   npm run start
   ```

## Проблемы с API Wiki.js

### Ошибка "Request failed with status code 400"

**Проблема**: При запуске скрипта миграции появляется ошибка "Request failed with status code 400".

**Решение**:

1. Проверьте правильность API-токена:

   ```bash
   npm run test:api
   ```

2. Если тест API не проходит, проверьте:

   - Правильно ли скопирован токен
   - Имеет ли токен необходимые права (полный доступ или доступ к страницам)
   - Не истек ли срок действия токена

3. Используйте исправленную версию скрипта миграции:
   ```bash
   npm run migrate:fix
   ```

### Ошибки в GraphQL запросах

**Проблема**: В ответах API появляются ошибки, связанные с GraphQL запросами.

**Решение**:

1. Проверьте синтаксис GraphQL запросов в скрипте миграции.

2. Исправленная версия скрипта (`improved-migration-fix.js`) использует два подхода к формированию запросов:

   - Прямая вставка значений через JSON.stringify
   - Использование переменных

3. Если одинаковые ошибки продолжают возникать:
   - Проверьте документацию API Wiki.js: https://docs.requarks.io/dev/api
   - Используйте GraphQL IDE для тестирования запросов: http://localhost:8080/graphql

### Ошибка "Field create argument isPrivate of type Boolean! is required"

**Проблема**: При создании страницы появляется ошибка о том, что не указан обязательный параметр isPrivate.

**Решение**:

1. В API Wiki.js недавно был добавлен обязательный параметр `isPrivate` для создания страниц.

2. Убедитесь, что в вашем скрипте миграции все мутации создания страниц включают параметр:

   ```graphql
   create(
     content: $content
     description: $description
     editor: "markdown"
     isPublished: true
     isPrivate: false  # Добавьте этот параметр
     locale: "ru"
     ...
   )
   ```

3. Запустите исправленные скрипты:
   ```bash
   npm run test:api
   npm run migrate:fix
   npm run migrate:single <путь>
   ```

### Ошибка "violates foreign key constraint pages_localecode_foreign"

**Проблема**: При создании страницы появляется ошибка о нарушении ограничения внешнего ключа для поля локали.

**Решение**:

1. Убедитесь, что в вашем скрипте миграции используется поддерживаемый код локали, например `en` вместо `ru`.

2. Исправьте параметр `locale` во всех скриптах миграции:

   ```graphql
   create(
     ...
     isPrivate: false
     locale: "en"  # Используйте "en" вместо "ru"
     ...
   )
   ```

3. Если вы хотите использовать русский язык, сначала установите эту локаль в настройках Wiki.js:
   - Перейдите в админ-панель > Система > Локализация
   - Добавьте русский язык
   - После этого можно будет использовать `locale: "ru"` в API запросах

## Проблемы с содержимым страниц

### Неправильное форматирование

**Проблема**: Страницы создаются, но маркдаун форматирование отображается некорректно.

**Решение**:

1. Убедитесь, что Wiki.js настроен на использование Markdown редактора.

2. Если в контенте есть специальные символы или конструкции, которые могут быть интерпретированы неправильно:
   - Добавьте обработку этих случаев в функцию `updateInternalLinks`.
   - Просмотрите проблемные страницы через редактор Wiki.js и исправьте форматирование вручную.

### Проблемы с ссылками между страницами

**Проблема**: Ссылки между страницами не работают после миграции.

**Решение**:

1. Функция `updateInternalLinks` преобразует относительные пути в абсолютные для Wiki.js.

2. Проверьте, правильно ли определяются пути в вашей структуре проекта.

3. Если нужно изменить логику преобразования путей:
   - Отредактируйте функцию `updateInternalLinks` в `improved-migration-fix.js`
   - Затем перезапустите миграцию для проблемных страниц

## Оптимизация процесса миграции

### Частичная миграция

Если полная миграция вызывает проблемы, вы можете мигрировать содержимое частями:

1. Создайте новый скрипт на основе `improved-migration-fix.js`, который будет обрабатывать только определенные директории:

```javascript
// Пример для миграции только персонажей
async function runPartialMigration() {
  console.log("Частичная миграция - только персонажи...");
  await processDirectory(path.join(sourceDir, "characters"));
  console.log("Частичная миграция завершена!");
}
```

2. Используйте скрипт для миграции небольших частей контента, проверяя результаты после каждого запуска.

### Миграция одиночных файлов

Если нужно мигрировать только один файл:

1. Создайте скрипт для миграции одного файла:

```javascript
async function migrateSingleFile(filePath, wikiPath) {
  const content = fs.readFileSync(filePath, "utf8");
  const metadata = extractMetadata(content);
  await createWikiPage(wikiPath, content, metadata);
}

// Пример: migrateSingleFile("../toron_cvetochek_rupert/characters/main_heroes/cvetochek.md", "characters/main_heroes/cvetochek");
```

## Поддержка после миграции

### Обновление контента

Поскольку вы используете систему миграции, вы можете:

1. Обновлять существующие страницы, если исходный контент изменится:

   ```bash
   npm run migrate:fix
   ```

   Скрипт обнаружит существующие страницы и обновит их.

2. Для обновления только измененных страниц можно создать скрипт сравнения версий.

### Резервное копирование

Обязательно настройте резервное копирование после успешной миграции:

1. В административной панели Wiki.js перейдите в "Система" > "Хранение".
2. Настройте хранилище для бэкапов.
3. Настройте регулярные бэкапы в разделе "Система" > "Бэкапы".

## Полное обновление системы

Если нужно полностью обновить Wiki.js и начать с нуля:

```bash
npm run stop
docker volume rm fairytale_wiki_db-data
npm run start
```

**ВНИМАНИЕ**: Это удалит все данные, включая страницы, настройки и учетные записи пользователей!

## Проверка состояния Wiki.js

Для проверки состояния Wiki.js и выявления возможных проблем можно использовать специальный скрипт:

```bash
npm run check
```

Этот скрипт выполнит следующие проверки:

1. Доступность сервера Wiki.js
2. Работа API Wiki.js и версия системы
3. Список существующих страниц
4. Список доступных локалей
5. Предоставит рекомендации по устранению проблем

### Типичные проблемы при запуске:

1. **Docker не запущен**:

   - Ошибка: "Cannot connect to the Docker daemon at unix:///var/run/docker.sock"
   - Решение: Запустите приложение Docker Desktop

2. **Контейнеры не запущены**:

   - Ошибка: "Failed to fetch" или "Connection refused"
   - Решение: Запустите контейнеры командой `npm run start`

3. **Порт занят другим приложением**:
   - Ошибка: "port is already allocated"
   - Решение: Остановите приложение, использующее порт 8080, или измените порт в docker-compose.yml
