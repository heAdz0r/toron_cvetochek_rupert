# Структура проекта WikiJs MCP

Этот документ описывает структуру проекта WikiJs MCP и назначение файлов.

## Основные файлы

### Скрипты запуска

- **mcp_wrapper.js** - универсальная обертка для запуска MCP сервера в различных режимах (HTTP или stdio) с учетом конфигурации Cursor
- **mcp_http_server.js** - HTTP сервер для Cursor MCP
- **mcp_wikijs_stdin.js** - сервер для Cursor MCP через stdio
- **start_http.sh** - скрипт для запуска HTTP сервера
- **start.sh** - скрипт для запуска базового сервера из директории dist

### Клиенты и тесты

- **mcp_client.js** - клиент для работы с MCP сервером через stdio
- **mcp_http_client.js** - клиент для работы с MCP сервером через HTTP
- **test_mcp.js** - скрипт для тестирования MCP
- **test_mcp_stdin.js** - скрипт для тестирования stdin-режима MCP
- **debug.js** - интерактивный скрипт отладки

### Исходные файлы TypeScript

Директория `src/` содержит исходный код на TypeScript:

- **api.ts** - GraphQL API клиент для Wiki.js
- **server.ts** - HTTP сервер
- **tools.ts** - определения инструментов MCP
- **types.ts** - типы TypeScript
- **agent.ts** - класс агента для использования MCP
- **demo.ts** - демонстрационный скрипт
- **schemas.ts** - Zod схемы для валидации параметров и результатов

### Скомпилированные файлы

Директория `dist/` содержит скомпилированные TypeScript файлы:

- **api.js** - GraphQL API клиент
- **server.js** - HTTP сервер
- **tools.js** - инструменты MCP
- **types.js** - типы
- **agent.js** - агент MCP
- **demo.js** - демонстрация
- **schemas.js** - схемы валидации

### Конфигурационные файлы

- **package.json** - описание проекта и скрипты npm
- **tsconfig.json** - конфигурация TypeScript
- **example.env** - пример файла переменных окружения

## Конфигурация Cursor

Для работы с Cursor необходимо создать файл `.cursor/mcp.json` в вашем проекте или в домашней директории:

```json
{
  "mcpServers": {
    "wikijs": {
      "transport": "http",
      "url": "http://localhost:3200/mcp",
      "events": "http://localhost:3200/mcp/events",
      "cwd": "/путь/к/директории/wikijs-mcp",
      "env": {
        "WIKIJS_BASE_URL": "http://localhost:8080",
        "WIKIJS_TOKEN": "ваш-токен-wiki-js"
      }
    }
  }
}
```

**ВАЖНО**: URL в конфигурации должен быть именно `/mcp` (для JSON-RPC) и `/mcp/events` (для SSE), а не отдельные имена инструментов.

## Интерфейсы API

MCP-сервер поддерживает два интерфейса API:

1. **REST API** (для прямого вызова инструментов):

   - `GET/POST /{tool_name}` - прямой вызов инструмента по имени

2. **JSON-RPC API** (для интеграции с Cursor):
   - `POST /mcp` - JSON-RPC 2.0 интерфейс для Cursor
   - `GET /mcp/events` - SSE интерфейс для событий MCP

## Правильный запуск проекта

### Подготовка к работе

1. Установка зависимостей:

   ```bash
   npm install
   ```

2. Сборка TypeScript-файлов:

   ```bash
   npm run build
   ```

3. Проверьте наличие конфигурационных файлов:
   - `.cursor/mcp.json` - для интеграции с Cursor
   - `example.env` или `.env` - для запуска в автономном режиме

### Запуск MCP HTTP сервера (рекомендуемый способ)

```bash
# Через bash-скрипт (рекомендуется)
./start_http.sh

# Или через npm
npm run server:http

# С указанием параметров напрямую
PORT=3200 WIKIJS_BASE_URL=http://localhost:8080 WIKIJS_TOKEN=your-token node mcp_http_server.js
```

### Запуск с использованием конфигурации Cursor

```bash
# Если сконфигурирован .cursor/mcp.json
node mcp_wrapper.js
```

Сервер по умолчанию запускается на порту 3200, если не указано иное через переменную окружения PORT.

### Проверка работоспособности сервера

После запуска вы можете проверить, что сервер работает:

```bash
# Проверка через curl
curl http://localhost:3200/health

# Ожидаемый результат:
# {"status":"ok","message":"MCP Server is running and connected to Wiki.js"}

# Проверка JSON-RPC интерфейса (для Cursor)
curl -X POST http://localhost:3200/mcp -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize"}'

# Получение списка инструментов через JSON-RPC
curl -X POST http://localhost:3200/mcp -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'
```

### Запуск в режиме stdio (для прямой интеграции с Cursor)

```bash
npm run server:stdio
```

## Использование клиентов

1. HTTP клиент (для сервера на порту 3200):

   ```bash
   MCP_SERVER_URL=http://localhost:3200 npm run http-client
   ```

2. stdio клиент:
   ```bash
   npm run client
   ```

## Тестирование

Для тестирования MCP сервера:

```bash
# Автоматическое тестирование HTTP сервера
npm run test

# Или напрямую
node test_mcp.js

# Тестирование stdio режима
node test_mcp_stdin.js

# Интерактивная отладка
npm run debug
```

## Отладка

1. Запуск интерактивного меню отладки:

   ```bash
   npm run debug
   ```

2. Проверка соединения с Wiki.js:

   ```bash
   curl http://localhost:3200/health
   ```

3. Получение списка доступных инструментов:

   ```bash
   # Через REST API
   curl http://localhost:3200/tools

   # Через JSON-RPC (для Cursor)
   curl -X POST http://localhost:3200/mcp -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'
   ```

4. Вызов инструмента через REST API:

   ```bash
   # Например, получение списка страниц
   curl http://localhost:3200/list_pages
   ```

5. Вызов инструмента через JSON-RPC:

   ```bash
   curl -X POST http://localhost:3200/mcp -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":1,"method":"tools/execute","params":{"name":"list_pages","params":{}}}'
   ```

6. Логи HTTP сервера сохраняются в файлах:

   ```bash
   # Основной лог сервера
   tail -f server.log

   # Лог отладки
   tail -f debug.log
   ```

## Интеграция с Cursor

1. Убедитесь, что HTTP-сервер MCP запущен:

   ```bash
   npm run server:http
   ```

2. Проверьте, что ваш файл конфигурации `.cursor/mcp.json` корректен:

   ```json
   {
     "mcpServers": {
       "wikijs": {
         "transport": "http",
         "url": "http://localhost:3200/mcp",
         "events": "http://localhost:3200/mcp/events",
         "cwd": "/полный/путь/к/директории/wikijs-mcp",
         "env": {
           "WIKIJS_BASE_URL": "http://localhost:8080",
           "WIKIJS_TOKEN": "ваш-токен-wiki-js"
         }
       }
     }
   }
   ```

3. Запустите или перезапустите Cursor для применения конфигурации MCP.

4. В Cursor вы должны увидеть новые инструменты Wiki.js в палитре команд.

## Примечания

- Порт по умолчанию для HTTP сервера - 3200
- MCP сервер требует доступа к действующему Wiki.js API
- Управление сервером осуществляется через скрипты в директории проекта
- Во всех примерах и скриптах используется относительный путь, поэтому убедитесь, что вы находитесь в директории проекта wikijs-mcp
- Для интеграции с Cursor используется JSON-RPC 2.0 протокол через эндпоинт `/mcp`
